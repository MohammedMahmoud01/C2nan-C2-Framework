#!/bin/bash

# Define the path to the Exploit Database archive on agent
edb_archive_path="/tmp/exploitdb.zip"

# Define the path to the local Exploit Database directory on agent
edb_directory_path="/tmp/exploitdb-main"

# Get the kernel version
kernel_version="$(uname -r | grep -oP '\d+\.\d+\.\d+-\d+')"

# Search for a CVE in Exploit Database for the kernel version
if [ -f "$edb_archive_path" ]; then
    # Extract the archive to the local directory if it exists
    unzip -qo "$edb_archive_path" -d "$(dirname $edb_directory_path)"
    cve_path=$(grep -r -m 1 -E "^.*$kernel_version.*CVE" "$edb_directory_path" | awk -F ',' '{print $2}')
    cve=$(basename "$edb_directory_path/$cve_path" .c)
else
    echo "Exploit Database archive not found at $edb_archive_path"
    exit 1
fi

if [ -n "$cve" ]; then
    # Download the C file for the CVE
    cp "$edb_directory_path/$cve_path" "$cve.c"
    echo "C file for $cve downloaded successfully"
    # Convert the C file to a Bash script and make it executable
    gcc -o "$cve" "$cve.c"
    chmod +x "$cve"
    echo "bash file is ready for execution"
    # Run the Bash script
    # ./$cve
else
    echo "No CVE found for kernel version $kernel_version"
fi
